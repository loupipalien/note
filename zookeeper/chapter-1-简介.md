### 简介

#### ZooKeeper 的使命
分布式系统中的通信有两种选择: 直接通过网络进行信息交换, 或者读写某些共享存储; ZooKeeper 使用共享存储模型来实现应用间的协作和同步原语, 对于共享存储本身, 又需要在进程和存储间进行网络通信

#### 示例: 主从应用
在分布是系统设计中一个得到广泛应用的架构是主从架构
```
                    ----------
                    | Master |
                    ----------
                        |
        ---------------------------------------
        |               |                     |
    --------        --------              --------
    | Work |        | Work |     ...      | Work |
    --------        --------              --------
```
在主从架构中, 主节点进程负责跟踪从节点状态和任务的有效性, 并分配任务到从节点; 要实现主从模式的系统, 需要解决以下三个问题
- 主节点崩溃
如果主节点发送错误并失效, 系统将无法分配新的任务或者重新分配已失败的任务
- 从节点崩溃
如果从节点崩溃, 已分配的任务将无法完成
- 通信故障
如果主节点和从节点之间无法进行信息交换, 从节点将无法得知新任务分配给它

##### 主节点失效
主节点失效时, 需要有一个备份主节点 (backup master) 来接管主要主节点 (primary master) 的角色, 进行故障转移; 新的主要主节点需要能够恢复到旧主要的主节点崩溃时的状态; 对于主节点状态的可恢复性, 不能依靠从已经崩溃的主节点来获取这些信息, 而需要从其他地方获取, 也就是通过 ZooKeeper 来获取  
状态恢复并不是唯一的重要问题; 假如主节点有效, 备份主节点却认为主节点已经崩溃 (例如由于网络原因导致消息延迟等), 备份主节点将会接管成为主节点的角色, 成为第二个主要主节点; 更糟糕的时, 如果一些从节点无法与主节点通信, 如由于网络分区 (network partition) 错误导致, 这些从节点可能会停止与主要主节点的通信, 而与第二个主要主节点建立主从关系, 这种问题称之为脑裂 (split-brain): 系统中两个或多个部分开始独立工作, 导致整体行为不一致

##### 从节点失效
客户端向主节点提交任务, 之后主节点将任务派发到有效的从节点中, 从节点接收到派发的任务, 执行完这些任务后会向主节点报告执行状态, 主节点下一步会将执行结果通知给客户端  
如果从节点崩溃了, 所有已派发给这个从节点且尚未完成的任务需要重新派发; 其中首要需求是让主节点具有检测从节点的崩溃的能力; 主节点必须能够检测到从节点的崩溃, 并确定哪些从节点有效以便派发节点的任务; 一个从节点崩溃时, 从节点也许执行了部分任务, 也许全部完成但还没有报告结果; 整个运算过程产生了其他作用, 还有必要执行某些恢复过程来清除之前的状态

##### 通信故障
如果一个从节点与主节点的网络连接断开, 比如网络分区导致, 重新分配一个任务可能会导致两个从节点执行相同的任务; 如果一个任务允许执行多次, 在任务再分配时可以不用验证第一个从节点是否完成了该任务, 如果不允许, 则需要适应多个从节点执行相同任务的可能性  
通信故障导致的另一个问题是对锁等同步原语的影响; 因为节点奔溃, 而系统也可能网络分区, 锁机制也会阻止任务的继续执行, 因此 ZooKeeper 也需要实现处理这些情况的机制; 首先客户端可以告诉 ZooKeeper 某些数据的状态是临时的 (ephemeral), 其次 ZooKeeper 需要客户端定时发送是否存活的通知, 如果一个客户端未能及时发送通知, 那么所有从属于这个客户端的临时状态数据将被全部删除; 通过这样的机制, 在崩溃或者通信故障发生时, 就可以预防客户端独立运行而发生的应用宕机

##### 任务总结
- 主节点选举
这是关键的一步, 使得主节点可以给从节点分配任务
- 崩溃检测
主节点必须具有检测从节点崩溃或者失去连接的能力
- 组成员关系管理
主节点必须具有知道哪一个从节点可以执行任务的能力
- 元数据管理
主节点和从节点必须具有通过某种可靠的方式来保存分配状态和执行状态的能力

#### 分布式协作的难点
当设计一个分布式系统时, 没有系统可以同时满足一致性 (Consistency), 可用性(Availability), 分区容错性(Partition-tolerance), 这被称为 CPA 定律

>[**拜占庭将军问题**](https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98)
在分布式计算中, 不同的计算机通过通讯交换信息达成共识而按照同一套协作策略行动; 但有时候, 系统中的成员计算机可能出错而发送错误的信息, 用于传递信息的通讯网络也可能导致信息损坏, 使得网络中不同的成员关于全体协作的策略得出不同结论, 从而破坏系统一致性

#### ZooKeeper 的成功和注意事项
TODO

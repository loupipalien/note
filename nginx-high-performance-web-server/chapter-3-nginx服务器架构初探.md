### Nginx 服务器架构初探

#### 模块化结构

##### 什么是模块化结构
模块化没有一个统一的概念, 但模块化一般可以从中提出几层含义
- 功能块是对模块的描述, 一个模块就是一个功能块, 应该只负责一个功能, 这对应于设计模式中的单一职责原则
- 如果要体现模块化, 就免不了对程序进行分解,  这对应于设计模式中的自顶向下逐步求精原则
- 一个程序被分解为多个模块, 那么它们之间一定要存在一定的依赖关系, 但是这个依赖不能太强, 需要高内聚低耦合; 这对应于设计模式中的迪米特原则

##### Nginx 模块化结构
Nginx 的模块主要分为五大类
- 核心模块: 如进程管理, 权限控制, 错误日志记录等
- 标准 HTTP 模块: 支持 Nginx 服务器的标准 HTTP 功能
- 可选 HTTP 模块: 支持 Nginx 服务器的扩展标准 HTTP 功能
- 邮件服务模块: 支持 Nginx 的邮件服务
- 第三方模块: 为了扩展 Nginx 服务应用, 完成特殊功能而有第三方机构或个人编写的可编译到 Nginx 中的模块

TODO

#### Nginx 服务器的 Web 请求处理机制
Web 服务器和客户端是一对多的关系, Web 服务必须有能力同时为多个客户端提供服务; 一般来说, 完成并行处理请求工作有三种方式可选择: 多进程方式, 多线程方式, 异步方式

##### 多进程方式 (如 Apache 服务器)
多进程方式是指, 服务器每当接收到一个客户端时, 就由服务器主进程生成一个子进程出来和该客户端建立连接进行交互, 直到连接断开, 该子进程就结束了  
多进程方式的优点在于, 设计和实现相对简单, 各个子进程之间相互独立, 处理客户端请求过程彼此不受到干扰, 并且当一个子进程产生问题时, 不容易将影响蔓延到其他进程中, 这保证了提供服务的稳定性; 当子进程退出时, 其占用资源会被操作系统回收, 也不会留下任何垃圾; 其缺点也是很明显的, 操作系统中生成一个子进程需要进行内存复制等操作, 在资源和时间上会产生一定的额外开销, 因此如果 Web 服务其接收大量并发请求, 就会对系统资源造成压力, 导致系统性能下降

##### 多线程方式 (如 IIS 服务器)
多线程方式和多进程方式相似, 它是值服务器每当接收到一个客户端时, 会由服务器主进程派生一个线程出来和客户端进行交互  
由于操作系统产生一个线程的开销远远小于产生一个进程的开销, 所以多线程方式在很大程度上减轻了 Web 服务器对系统资源的要求; 在线程管理方面, 该方式有一定的不足, 多线程位于同一个进程内, 可以访问同样的内存空间, 彼此之间相互影响; 同时在开发过程中不可避免的要求开发者自己对内存进行管理, 这增加了出错的风险; 服务器需要长时间不停的运行, 错误的逐渐积累可能最终对整个服务器产生重大影响

##### 异步方式
异步方式是和多进程方式和多线程方式完全不同的一种处理客户端请求的方式; 在这之前先了解一下 `同步, 异步, 阻塞, 非阻塞` 这几个概念  
网络通信中的同步机制和异步机制是描述通信模式的概念; 同步机制是指发送方发送请求后, 需要等待接收到接收方发回的响应后, 才接着发送下一个请求; 异步机制和同步机制相反, 在异步机制中, 发送方发出一个请求后, 不等待接收方响应这个请求, 就继续发送下个请求; 在同步机制中, 所有的请求在服务器端得到同步, 发送方和接收方的处理步调是一致的; 在异步机制中, 所有来自发送方的请求形成一个队列, 接收方处理完成后通知发送方  
阻塞和非阻塞用来描述进程处理调用的方式, 在网络通信中, 主要指网络套接字 Socket 的阻塞和非阻塞方式, 而 Socket 的实质也就是 IO 操作; Socket 的阻塞调用方式为, 调用结果返回之前, 当前线程从运行状态被挂起, 一直等到调用结果返回之后, 才进入就绪状态获取 CPU 后继续执行; Socket 的非阻塞调用结果方式和阻塞调用方式相反, 在非阻塞方式中, 如果调用结果不能马上返回, 当前线程也不会别挂起, 而是立即返回执行下一个调用  
这两对概念有一定的区别, 不能混淆; 两队概念的组合, 就会产生四个新的概念: `同步阻塞, 异步阻塞, 同步非阻塞, 异步非阻塞`
- 同步阻塞
发送方向接收方发送请求后, 一直等待响应; 接收方处理请求时进行的 IO 操作如果不能马上得到结果, 就一直等待到返回结果才响应发送方, 期间不能进行其他工作
- 同步非阻塞 (实际中不会使用这种方式)
发送方向接收方发送请求后, 一直等待响应; 接收方处理请求时进行的 IO 操作如果不能马上得到结果, 就立即返回去做其他事情, 但由于没有得到请求处理结果, 不响应发送方, 发送方一直等待; 一直到 IO 操作完成之后, 接收方获得结果响应发送方后, 接收方在进入下一个请求过程
- 异步阻塞 (实际中不会使用这种方式)
发送方向接收方发送请求后, 不用等待响应, 可以接着进行其他工作; 接收方处理请求时进行的 IO 操作如果不能马上得到结果, 就一直等到返回结果后, 才响应发送方, 期间不能进行其他工作
- 异步非阻塞
发送方向接收方发送请求后, 不用等待响应, 可以继续其他工作; 接收方处理请求时进行的 IO 操作如果不能马上得到结果, 也不等待而是马上返回去做其他事情; 当 IO 操作完成之后, 将完成状态和结果通知接收方, 接收方再响应发送方

##### Nginx 服务器如何处理请求

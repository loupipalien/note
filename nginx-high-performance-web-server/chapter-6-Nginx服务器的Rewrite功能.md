### Nginx 服务器的 Rewrite 功能
Rewrite 功能是大多数 Web 服务器支持的一项功能, 其在提供重定向服务时起到主要作用

#### Nginx 后端服务器组的配置的 5 个指令
Nginx 服务器支持设置一组服务器作为后端服务器; 服务器组的设置包括几个指令, 它们是由标准 HTTP 模块 ngx_http_upstream_module 进行解析和处理的
##### upstream 指令
该指令是u设置后端服务器组的主要指令, 其他的指令都在该指令中进行设置; upstream 指令类似与之前提到的  http 块等, 其语法结构为
```
upstream name {...}
```
其中 name 是给后端服务器起的组名, 花括号中列出后端服务器组中包含的服务器, 其中可以使用以下指令  
默认情况下, 某个服务器组接收到请求以后, 按照轮询调度 (Round-Robin, RR) 策略顺序选择组内服务器处理请求; 如果一个服务器处理请求的过程中出现错误, 请求会被顺次交给组内的下一个服务器进行处理, 直到返回正常响应; 但是如果所有的组内服务器都出错, 则返回最后一个服务器的处理结果 (当然也可以给服务器依据能力的不同分配权重)
##### server 指令
该指令用于设置组内的服务器, 其语法结构为
```
server address [parameters];
# address: 服务器的地址, 可以是包含端口号的 IP 地址, 域名或者以 "unix:" 为前缀用于进程间通信的 Unix Domain Socket
# parameters: 为当前服务器配置更多属性
  # weight=number: 为组内服务器配置权重, 权重值高的服务器被优先用于处理请求, 默认值为 1
  # max_fails=number: 设置一起请求失败的次数; 在一定时间范围内, 当对组内某台服务器请求失败次数超过该变量设置的值时, 认为该服务器无效, 默认值是 1; 如果设置为 0, 则不使用上面的办法检查服务器是否有效
  # fail_timeout=time: 有两个作用, 一是设置 max_fails 指令尝试请求某台组内服务器的时间; 另一个作用是在检查服务器是否有效时, 如果一台服务器被认为是无效的, 该变量设置的时间为认为服务器无效的持续时间, 在这个时间内不再检查该服务器的状态, 并认为它是无效的; 默认值是 10s
  # backup: 将某台组内服务器标记位备用服务器, 只有当正常的服务器处于无效 (down) 或繁忙 (busy) 状态时, 该服务器才内用来处理客户端请求
  # down: 将某台服务器记为永久的无效状态, 通常与 ip_hash 指令配合使用
```
##### ip_hash 指令
该指令用于实现会话保持功能, 将某个客户端的多次请求定向到组内同一台服务器上, 保证客户端与服务器之间建立稳定的会话, 只有当该服务器处于无效状态时, 客户端请求才会被下一个服务器接收和处理, 其语法结构为
```
ip_hash;
```
ip_hash 技术在一些情况下非常有用, 能够避免服务器组内个服务器之间会话共享的问题, 但 ip_hash 技术在实际使用中也有一些限制  
首先, ip_hash 指令不能与 server 指令中的 weight 变量一起使用; 其次, 由于 ip_hash 技术主要根据客户端 IP 地址分配服务器, 因此整个系统中 Nginx 服务器应该是处于最前端的服务器, 否则可能取不到真正的 IP 地址, 同时也要注意 IP 地址必须是 C 类地址
##### keepalive 指令
该指令用于控制网络连接保持功能, 通过该指令, 能够保证 Nginx 服务器的工作进程为服务器组打开一部分网络连接, 并且将数量控制在一定的范围之内, 其语法结构为
```
keepalive connections;
```
其中, connections 为 Nginx 服务器的每一个工作进程允许该服务器组保持的空闲网络连接数的上限值; 如果超过该值, 将采用最近最少使用的策略关闭网络连接
##### least_conn 指令
该指令用于配置 Nginx 服务器使用负载均衡策略为网络连接分配服务器组内的服务器; 该指令在功能上实现了最少连接负载均衡算法, 在选择组内的服务器时考虑各服务器权重的同时, 每次选择的都是当前网络连接最少的那台服务器, 如果有多台这样的服务器则采用加权轮询原则选择; 其语法结构为
```
least_conn;
```

#### Rewrite 功能的配置
URL 重写是非常有用的功能, 它可以在改变网站结构后保证原有 URL 的正确跳转; Nginx 服务器的 Rewrite 功能实现依赖 PCRE (Perl Compatibele Regular Expressions, Perl 兼容的正则表达式)

##### 地址重写与地址转发
这两个过程是不同的, 有以下区别
- 地址转发后客户端浏览器地址栏中显示的不变; 而地址重写后客户端浏览器地址中的地址会改变
- 在一次地址转发的过程中只产生一次网络请求; 而一次地址重写一般会产生两次请求
- 地址转发一般发生在同一站点项目内; 而地址重写则没有该限制
- 地址转发到的页面可以不用全路径名表示; 而地址重写的页面必须用完整的路径表示
- 地址转发过程中, 可以将客户端请求的 request 范围内属性传递给新的页面; 而地址重写不可以
- 地址转发的速度叫地址重写快

##### Rewrite 规则
Rewrite 规则是学习和使用 Nginx 服务器 Rewrite 功能的基础, 可以借助 PCRE 实现 URI 的重写, 并且它还支持 Nginx 预设变量; Rewrite 规则的核心就是 PCRE
##### if 指令
该指令用来支持条件判断, 并根据条件判断结果选择不同的 Nginx 配置, 可以在 server 块或 location 块中配置该指令, 其语法结构为
```
if (condition) {...}
```
condition 支持以下几种设置方法
- 变量名: 如果变量的值为空字符串或以 "0" 开头的任意字符串, if 指令认为条件为 false, 其他情况认为条件为 true
- 使用 "=" 和 "!=" 比较变量和字符串是否相等
- 使用正则表达式对变量进行匹配, 匹配成功时 if 指令认为条件为 true, 否则为 false; 变量与正则表达式之间使用 `~, ~*, !~, !~*` 连接, `~` 表示匹配过程中对大小写敏感, `~*` 表示匹配过程中对大小写不敏感; 使用 `!~, !~*`, 匹配失败时 if 指令认为条件为 true, 否则为 false; 在正则表达式中, 可以使用小括号对变量值进行截取, 在花括号这个i不过使用 `$1...$9` 引用截取的值
- 判断请求的文件是否存在使用 `-f, !-f`; 当使用 `-f` 时, 如果请求的文件存在为 true, 否则为 false; 使用 `!-f` 时, 如果请求的文件不存在但该文件所在的目录存在, if 指令认为条件为 true, 如果该文件和它所在的目录都不存在则为 false, 如果请求的文件存在则为 false
- 判断请求的目录是否存在使用 `-d, !-d`
- 判断请求的目录或文件是否存在使用 `-e, !-e`
- 判断请求的文件是否可执行使用 `-x, !-x`

##### break 指令
该指令用于中断当前相同作用域中的其他 Nginx 配置; 该指令处于同一作用域的 Nginx 配置中, 位于它前面的指令配置生效, 位于指令后面的配置无效; Nginx 服务器在根据破欸之处理请求的过程中遇到该指令时, 回到上一层作用域继续向下读取配置; 该指令可以在 server, location, if 块中使用; 其语法结构为
```
break;
```
示例
```
location / {
    if ($slow) {
        set $id $1; # 有效
        break;
        limit_rate 10k;  # 无效
    }
    ... # 上一层作用域的配置都有效
}
```

### 路由协议

#### 路由控制的定义
##### IP 地址与路由控制
互联网时由路由器连接的网络组合而成的, 为了能让数据包正确到达目标主机, 路由器必须在途中进行正确的转发, 这种向 "正确的方向" 转发数据所进行的处理就叫做路由控制或路由; 路由器根据路由控制表转发数据包, 它根据所收到的数据包中目标主机的 IP 地址与路由控制表比较得出下一个应该接收的路由器

##### 静态路由与动态路由
静态路由是指事先设置好路由器和主机中并将路由信息固定的一种方法, 而动态路由是指让路由协议在运行过程中自动的设置路由控制信息的一种方法

##### 动态路由的基础
动态路由会给相邻路由器发送自己已知的网络连接信息, 而这些信息又像接力一样依次传递给其他路由器, 直至整个网络都了解时, 路由控制表也就制作完成了, 也就可以正确的转发 IP 数据包了

#### 路由控制范围
根据路由控制的范围常使用 IGP (Interior Gateway Protocol) 和 EGP (Exterior Gateway Protocol) 两种类型的路由协议

##### 接入互联网的各种组织机构
没有管理者, 也没有被管理者, 每个组织之间保持着平等的关系

##### 自治系统和路由协议
制定自己的路由策略, 并一次为准在一个或多个网络群体中采用的小型单位叫做自治系统 (AS: Autonomous System) 或路由选择域 (Routing Domain); 区域网络, ISP (互联网服务提供商) 都是典型的例子, 在自治系统内部, 运营者制定出路由控制相关方针, 然后根据此方针进行具体路由控制的设定  
自治系统 (路由选择域) 内部动态路由采用的协议是域内路由协议 (IGP), 而自治系统之间的路由控制采用的是域间路由协议 (EGP)

##### IGP 和 EGP
路由协议被分为 EGP 和 IGP 两个层次, 没有 EGP 就不可能有世界各个不同组织之间的通信, 没有 IGP 机构内部也就不可能进行通信  
IGP 中还可以使用 RIP (Routing Information Protocol, 路由信息协议), RIP2, OSPF(Open Shortest Path First, 开放式最短路径优先) 等众多协议; 与之相对, EGP 使用的是 BGP (Border Gateway Protocol, 边界网关协议) 协议

#### 路由算法
路由控制算法最具代表性的两种: 距离向量 (Distance-Vector) 算法和链路状态 (Link-State) 算法

##### 距离向量算法
距离向量算法 (DV) 是根据距离 (代价) 和方向决定目标网络或目标主机位置的一种方法  
路由器之间可以互换目标网络的方向及其距离的相关信息, 并以这些信息为基础制作路由控制表

##### 链路状态算法
链路状态算法是路由器在了解网络整体连接状态的基础上生成路由控制表的一种方法, 该方法中每个路由器必须保持同样的信息才能进行正确的路由选择

##### 主要路由协议
| 路由协议名 | 下一层协议 | 方式 | 适用范围 | 循环检测 |
| :--- | :--- | :--- | :--- | :--- |
| RIP | UDP | 距离向量 | 域内 | 不可以 |
| RIP2 | UDP | 距离向量 | 域内 | 不可以 |
| OSPF | IP | 链路状态 | 域内 | 可以 |
| EGP | IP | 距离向量 | 对外连接 | 不可以 |
| BGP | TCP | 路径向量 | 对外连接 | 可以 |

其中由于 EGP 不支持 CIDR, 现在已不再作为对外连接协议了

### RIP
RIP (Rounting Information Protocol) 是距离向量型的一种路由协议, 广泛用于 LAN, 被 BSD UNIX 作为标准而提供 rounted 采用了 RIP

##### 广播路由控制信息
RIP 将路由控制信息定期 (30 秒一次) 向全网广播, 如果没有收到路由控制信息, 连接就会被断开, RIP 规定可等待 5 次; 如果等待 6 次仍未收到路由信息, 才会真正关闭连接

##### 根据距离向量确定路由
RIP 基于距离向量算法决定路径, 距离 (Mtrics) 的单位为 "跳", 即所经过路由器的个数, RIP 希望尽可能少通过路由器数据包转发到目标 IP 地址

##### 使用子网掩码时的 RIP 处理
RIP 虽然不交换子网掩码的信息, 但可以用于使用子网掩码的网络环境, 在这种情况下需要注意以下几点
- 从接口的 IP 地址对应分类得到网络地址后, 与根据路由控制信息流过此路由器的包中的 IP 地址对应的分类得出的网络地址进行比较, 如果两者的网络地址相同, 那么就以接口的网络地址长度为准
-  
如果两者的网络地址不同, 那么以 IP 地址的分类所确定的网络地址长度为准

##### RIP 中路由变更时的处理
TODO

##### RIP2
RIP2 是 RIP 协议的第二版, 在 RIP 基础上增加了以下特性
- 使用多播
RIP 中当路由器之间交换路由信息时采用广播的形式, 然而在 RIP2 中改用了多播, 这样不仅减少了网络的流量, 还缩小了无关主机的影响
- 支持子网掩码
与 OSPF 类似, 支持在交换的路由信息中加入子网掩码信息
- 路由选择域
与 OSPF 类似, 在同一网络中可以使用逻辑上独立的多个 RIP
- 外部路由标志
通常用于把从 BGP 等获得的路由控制信息通过 RIP 传递给 AS 内
- 身份验证密钥
与 OSPF 类似, RIP 包中携带密码, 只有在自己能够识别这个密码时才接收数据, 否则忽略这个 RIP 包

#### OSPF
OSPF (Open Shortest Path First) 是根据 OSI 的 IS-IS 协议提出的一种链路状态型路由协议, 由于采用链路状态类型, 所以即使网络中有环路, 也能够进行稳定的路由控制   
为了减少网络流量, OSPF 还引入了 "区域" 的概念, 区域是一个自治网络划分为若干个更小的范围, 由此可以减少路由协议之间不必要的交换

##### OSPF 是链路状态型路由协议
OSPF 为链路状态型路由器, 路由器之间交换链路状态生成网络拓扑信息, 然后再更根据这个拓扑信息生成路由控制表  
OSPF 给每条链路赋予一个权重, 并始终选择一个权重最小的路径作为最终路由, 也就是说 OSPF 以每个链路上的代价为度量标准, 始终选择一个总的代价最小的一条路径

##### OSPF 基础知识
在 OSPF 中, 把连接到同一个链路的路由器称作相邻路由器, 在一个相对简单的网络结构中, 例如每个路由器仅和一个路由器相互连接时, 相邻路由器之间可以交换路由信息, 但是在一个比较复杂的网络中, 例如在同一个链路中加入了以太网或 FDDI 等路由器时, 就不需要再所有相邻的路由器之间都进行控制信息的交换, 而是确定一个指定路由器并以它为中心交换路由信息即可  
RIP 中包的类型只有一种, 它利用路由控制信息, 一边确认是否连接了网络, 一边传送网络信息, 但是这种方式, 有一个严重的缺点, 那就是网络个数越多, 每次所要交换的路由控制信息就越大, 而且当网络已经处于比较稳定的, 没有什么变化的状态时, 还是要定期交换相同的路由控制信息, 这在一定程度上浪费了网络带宽; 在 OSPF 中有 5 中类型的包

| 类型 | 包名 | 功能 |
| :--- | :--- | :--- |
| 1 | 问候 (Hello) | 确认相邻路由器, 确定指定路由器 |
| 2 | 数据库描述 (Database Description) | 链路状态数据库的摘要信息 |
| 3 | 链路状态请求 (Link State Request) | 请求从数据库中获取链路状态信息 |
| 4 | 链路状态更新 (Link State Update) | 更新链路状态数据库中的链路状态信息 |
| 5 | 链路状态确认应答 (Link State Acknowledgement) | 链路状态信息更新的确认应答 |

有这样一个机制后, OSPF 可以大大减少网络流量, 还可以达到迅速更新路由信息的目的

##### OSPF 工作原理概述
TODO

##### 将区域分层化进行细分管理
链路状态型路由协议的潜在问题是, 当网络规模越来越大时, 表示链路状态的拓扑数据库就变得越来越大, 路由控制信息的计算也就越困难, OSPF 为了减少计算负荷, 引入了区域的概念  
区域是指将连接在一起的网络和主机划分成小组, 使一个自治系统 (AS) 内可以拥有多个区域; 具有多个区域的自治系统必须有一个主干区域, 其他区域必须都与这个主干区域相连接  
连接区域与主干区域的路由器称作区域边界路由器, 区域内部的路由器叫做内部路由器, 只与主干区域内连接的路由器叫做主干路由器, 与外部相连接的路由器就是 AS 边界路由器  
每个区域内的路由器都持有本区域网络拓扑的数据库, 然而关于区域之外的路径信息, 只能从区域边界路由器获知它们的距离, 区域边界路由器也不会将区域内的链路状态发送给其他区域, 只会发送自己到达这些路由器的距离信息; 内部路由器所持有的网络拓扑数据就会明显变小

#### BGP
BGP (Border Gateway Protocol), 边界网关协议是连接不同的组织机构的一种协议, 属于外部网关协议 (EGP), 主要用于 ISP 之间相连接的部分, 只有 BGP, RIP, OSPF 共同进行路由控制, 才能够进行整个互联网的路由控制

##### BGP 和 AS
TODO

##### BGP 是路径向量协议
TODO

##### MPLS
现如今, 在转发 IP 数据包的过程中处理使用路由技术外, 还在使用标记交换技术; 路由技术基于 IP 地址中最长匹配原则进行转发, 而标记交换则对每个 IP 包都设定一个叫做 "标记" 的值, 然后再根据这个标记进行转发; 标记交换技术中最具代表性的当属多协议标记交换技术, 即 MPLS (Multi Protocol Label Switching)  
MPLS 不需要具备以太网或 ATM 等数据链路层协议的作用, 只需要关注它与下一层 IP 层之间的功能和协议即可  
由于基于标记转发通常无法再路由器上进行, 所以也就无法被整个互联网采用

##### MPLS 的网络基本动作
MPLS 网络中实现 MPLS 功能的路由器叫做标记交换路由器 (LSR, Label Switching Router), 特别是与外部网络连接的部分 LSR 叫做标记边缘路由器, MPLS 正是在 LER 上对数据包进行追加标记和删除标记的操作

##### MPLS 的优点
- 转发速度快
- 可利用标记生成虚拟的路径, 并在它的上面实现 IP 等数据包的通信

### IP 协议
#### IP 即网际协议
TCP/IP 的心脏是互联网层, 这一层主要由 IP (Internet Protocol) 和 ICMP (Internet Control Message Protocol) 两个协议组成

##### IP 相当于 OSI 参考模型的第 3 层
IP (IPv4,IPv6) 相当于 OSI 参考模型中的第 3 层 (网络层); 网络层的主要作用是 "实现终端节点之间的通信"; 这种终端节点之间的通信也叫 "点对点通信"; 网络层的下一层数据链路层主要作用是在互连同一种数据链路的节点之间进行包传递, 而一旦跨越多种数据链路, 就需要借助网络层; 网络层可以跨越不同的数据链路, 即使是在不同的数据链路上也能实现两端节点之间的数据包传输

##### 网络层与数据链路层的关系
```
            | 以太网      IP-VPN       千兆以太网     ATM   |
火车票或机票 |-------->|----------->|------------->|------->| 数据链路层
            |      数据链路只负责某一个区间之间的通信传输     |
            |                                              |
旅行的行程表 |--------------------------------------------->| 网络层
            | IP 负责将数据包发给最终的目标地址, 即点对点通信  |
```

#### IP 基础知识
IP 大致分为三大作用模块, 分别是 IP 寻址, 路由, IP 分包与组包

##### IP 地址属于网络层地址
在数据链路层中 MAC 地址作为同一链路中不同计算机的一种识别码, 作为网络层也有类似的信息, 叫做 IP 地址, 用于在 "连接到网络重的所有主机中识别出进行通信的目标地址"

##### 路由控制
路由控制 (Rounting) 是指将分组数据发送到最终目标地址的功能, 即使网络非常复杂, 也可以通过路由控制确定到达目标地址的通路
- 发送数据至最终目标地址
Hop 被译为跳 (指利用数据链路层以下分层的功能传输数据帧的一个区间), 是指网络中的一个区间, IP 包正是在网络中一个跳间被转发, 因此 IP 路由也叫做多跳路由, 在每个区间内决定着包下一跳被转发的路径; 多跳路由是路由器或主机在转发 IP 数据包时只指定下一个路由器或主机, 而不是将到最终目标地址为止的所有全都指定出来
- 路由控制表
为了将数据包发送给目标主机, 所有主机都维护着一张路由控制表 (Rounting Table), 该表记录 IP 数据在下一步应该发送给哪个路由器, IP 包将根据这个路由表在各个数据链路上传输

##### 数据链路的抽象化
IP 是实现多个数据链路之间通信的协议, 数据链路根据种类的不同各有特点, 对这些数据链路的相异特性进行抽象化也是 IP 的重要作用之一  
不同数据链路有个最大的区别, 就是它们各自的最大传输单位 (MTU: Maximum Transmission Unit) 不同, 为了解决这个问题, IP 进行分片处理 (IP Fragmentation), 即将较大的 IP 包分层多个较小的 IP 包, 分片的包到了目标地址后会被在组合起来传给上一层

##### IP 属于面向无连接型
IP 面向无连接, 即在发包之前, 不需要建立与对端目标地址之间的连接; 采用无连接的主要是为了简化和提速; 面向连接比起面向无连接处理相对复杂, 并且每次建立连接会降低处理速度, 可以委托上一层来提供此项服务

#### IP 地址的基础知识
IP 地址 (IPv4 地址) 由 32 位正整数来表示, TCP/IP 通信要求将这样的 IP 地址分配给每一个参与通信的主机, IPv4 最多允许 $2^32 = 4294967296$ 台计算机连接到网络, 但实际上 IP 地址不是按主机台数来配置的, 而是按网卡 (NIC) 来设置 IP 的, 通常一块网卡只设置一个 IP 地址, 其实一块网卡也可以配置多个 IP 地址

##### IP 地址由网络标识和主机标识两部分组成
网络标识在数据链路的每个段配置不同的值, 网络表示必须保证相互连接的每个段的地址不相重复, 而相同段内主机必须有相同的网络地址, IP 地址的主机标识则不允许在同一个段内重复出现; 由此可保证在相互连接的整个网络中保证每台主机的 IP 地址都不会重复, 即 IP 地址具有唯一性

##### IP 地址的分类
IP 地址分为四个级别, `A, B, C, D`, 是根据 IP 地址中从第 1 位到第 4 位的比特列队其网络标识和主机标识进行区分

- A 类地址
以 "0" 开头, 1 至 8 位是它的网络标识, 即 `0.0.0.0 ~ 127.0.0.0` 是 A 类的网络地址, A 类地址的后 24 位是主机标识, 因此一个网段内可容纳的主机地址上限为 16777214 个
- B 类地址
以 "10" 开头, 1 至 16 位是它的网络标识, 即 `128.0.0.0 ~ 191.255.0.0` 是 B 类的网络地址, B 类地址的后 16 位是主机标识, 因此一个网段内可容纳的主机地址上限为 65534 个
- C 类主机
以 "110" 开头, 1 至 24 位是它的网络标识, 即 `192.0.0.0 ~ 223.255.255.0` 是 C 类的网络地址, C 类地址的后 8 位是主机标识, 因此一个网段内可容纳的主机地址上限为 254 个
- D 类地址
以 "1110" 开头, 1 至 32 位是它的网络标识, 即 `224.0.0.0 ~ 239.255.255.255` 是 D 类的网络地址, D 类地址没有主机标识, 常被用于多播
- 关于分配 IP 主机地址的注意事项
用比特位标识主机地址时, 不可以全部为 0 或全部为 1, 因为全部为 0 表示对应网络地址或 IP 地址不可获知的情况下才使用, 全部为 1 的主机地址通常作为广播地址

##### 广播地址
广播地址用于在同一个链路中相互连接的主机之间发送数据包, 将 IP 地址中的主机标识部分全部设置为 1, 就是广播地址
- 两种广播
分为本地广播和直接广播; 在本网络内的广播叫做本地广播, 如网络地址为 `192.168.0.0/24` 的情况下, 广播地址为 `192.168.0.255`, 这个广播地址的 IP 包会被路由器屏蔽, 不会到达 `192.168.0.0/24` 以外的其他链路上; 在不同网络之间的广播叫做直接广播, 如网络地址为 `192.168.0.0/24` 的主机向 `192.168.1.255/24` 的目标地址发送 IP 包, 收到这个包的路由器将数据转发给 `192.168.1.0/24`, 从而使所有 `192.168.1.1 ~ 192.168.1.254` 的主机都能收到这个包

##### IP 多播
多播用于将包发送给特定组内的所有主机, 由于其直接使用 IP 协议, 因此也不存在可靠传输
- IP 多播与地址
多播使用 D 类地址, 从 `224.0.0.0 ~ 239.255.255.255` 都是多播地址的可用范围, 其中 `224.0.0.0 ~ 224.0.0.255` 的范围不需要路由控制, 在同一个链路内也能实现多播, 在这个范围之外设置多播地址会给全网所有组内成员发送多播的包

TODO

##### 子网掩码
网络标识相同的计算机必须同属同一链路, 架构 B 类 IP 网络时理论上一个链路允许 65534 台主机, 然而实际中并不存在这样的网络结构; 因此直接使用 A 类或 B 类地址容易存在浪费, 有一种新的组合方式可以减少这种浪费

- 子网与子网掩码
IP 地址的网络标识和主机标识已不再受限于该地址的类别, 而是一个叫做 "子网掩码" 的识别码通过子网网络地址细分出比 A 类, B 类, C 类更小粒度的网络, 这种方式就是将原主机地址的部分作为子网地址, 可以将原网络分为多个物理网络的一种机制

##### CIDR 与 VLSM
IPv4 地址分类无法满足需求时, 人们开始放弃 IP 地址的分类, 采用任意长度分割 IP 地址的网络标识和主机标识, 这种方式叫做 CIDR, 意为 "无类型域间选路", 根据 CIDR 连续多个 C 类地址可以划分到一个较大的网格内, 有效非利用了当前 IPv4 地址, 同时通过路由集中降低了路由器的负担  
CIDR 被应用的初期, 网络内部采用固定长度的子网掩码机制, 然而在实际情况中, 有的子网需要 500 个 IP , 有个子网只需要 50 个 IP, 于是产生了一种可以随机修改组织内部各部门的子网掩码长度的机制 VLSM (可变长子网掩码),  它可以通过域间路由协议转换为 RIP2 以及 OSPF 实现  
CIDR 和 VLSM 技术确实缓解了全局 IP 地址不够用的问题, 但并不能从根本上解决 IPv4 地址有限的问题

##### 全局地址与私有地址
随着网络的迅速普及, IP 地址不足的问题日趋显著, 于是出现了一种先的技术, 它不要求为每台主机或路由器配置一个固定的 IP 地址, 而是在必要的时候只为相应数量的设备分配唯一的 IP 地址, 对于安歇没有连接互联网的独立网络中的主机, 分配私有网络里的 IP 地址即可  
私有 IP 最早没有计划连接互联网, 而只是用于互联网之外的独立网络, 当能够互换私有 IP 与全局 IP 的 NAT 技术诞生之后, 配有私有地址的主机与配有全局地址的互联网主机实现了通信  
全局 IP 地址基本上要在整个互联网内保持唯一, 但私有地址不需要, 只要在同一个域保持唯一即可  
私有 IP 地址结合 NAT 技术已成为现在解决 IP 地址分配问题的主流方案

##### 全局地址由谁定
在世界范围内, 全局 IP 由 ICANN 进行管理

#### 路由控制
发送数据包使用的地址是网络层的地址, 即 IP 地址; 然而仅仅有 IP 地址还不足已实现将数据包发送到目标地址, 在数据发送的过程中还需要类似于 "指明路由器或主机" 的信息, 以便真正发往目标地址; 保存这种信息的就是路由控制表; 实现 IP 通信的主机和路由器都必须持有一张这样的表, 也正是在这个表格基础上才得以进行数据包发送的  
该路由控制表形成方式有两种: 一种是管理员手动设置, 一种是路由器与其他路由器相互交换信息时自动刷新  
IP 本身并没有定义制作路由控制表的协议, 该表是由一个叫做 "路由协议" 的协议制作而成的

##### IP 地址与路由控制
路由控制表中记录着网络地址与下一步应该发送至路由器的地址, 在发送 IP 包时, 首先确定 IP 包首部的目标地址, 再从路由器中找到与该地址具有相同网络地址的记录, 根据该记录将 IP 转发给相应的下一个路由器
- 默认路由
默认路由是指路由表中任何一个地址都能与之匹配的记录, 一般标记为 `0.0.0.0/0` 或 `default`
- 主机路由
"IP 地址/32" 也被称为主机路由, 即整个 IP 地址都将参与路由, 进行主机路由, 意味着要基于主机上网卡上配置的 IP 地址本身, 而不是基于该地址的网络地址部分进行路由
- 环回路由
是在同一台计算机上的程序之间进行网络通信时所使用的一个默认地址, 计算机使用一个特殊的 IP 地址 `127.0.0.1` 作为环回地址, 与该地址具有相同意义的是一个叫做 `localhost` 的主机名, 使用这个 IP 或主机名时, 数据包不会流向网络

##### 路由控制表的聚合
TODO

#### 分割处理与再构成处理
##### 数据链路不同, MTU 则相异
每种数据链路的最大传输单元 (MTU) 都不尽相同, 每种数据链路的 MTU 之所以不同时因为不同类型的数据链路的使用目的不同, 使用目的不同可承载的 MTU 也就不同; 鉴于 IP 属于数据链路的上一层, 必须不受限与不同数据链路的 MTU 大小

| 数据链路 | MTU (字节) | 总长度 (单位字节, 包含 FCS) |
| :--- | :--- | :--- |
| IP 的最大 MTU | 65535 | - |
| Hyperchannel | 65535 | - |
| IP over HIPPI | 65280 | - |
| 16Mbps IBM Token Ring | 17914 | 17958 |
| IP over ATM | 9180 | - |
| IEEE 802.4 Token Bus | 8166 | 8191 |
| IEEE802.5 Token Ring | 4464 | 4508 |
| FDDI | 4352 | 4500 |
| 以太网 | 1500 | - |
| IEEE 802.3 Ethernet | 1492 | 1518 |
| PPPoE | 1492 | - |
| X.25 | 576 | - |
| IP 的最小 MTU | 68 | - |

#### IP 报文的分片与重组
任何一台主机都有必要对 IP 分片 (IP Fragmentation) 进行相应的处理, 进过分片之后的 IP 数据报在被重组的时候, 只能由目标主机进行, 路由器虽然做分片但不做重组   
路由器不做重组的原因是, 现实中无法保证 IP 数据报是否经由同一个路径传送, 在途中某一处被重新组装, 下一站再经过其他路由器还会面临分片的可能, 这会给路由器带来多余的负担, 降低网络的传输效率; 出于这些原因, 在终点端重组 IP 数据报成为现行规范

##### 路径 MTU 发现
路径 MTU (Path MTU) 是指从发送端主机到接收端主机之间不需要分片时最大 MTU 的大小, 即路径中存在的所有数据链路中最小的 MTU： 而路径 MTU 发现主机按照路径 MTU 的大小将数据分片后进行发送, 进行路径 MTU 发现, 就可以避免在中途的路由器上进行分片处理, 也可以在 TCP 中发送更大的包  
路径 MTU 发现的工作原理: 首先在发送端主机发送 IP 数据包时将其首部非分片禁止标志位设置为 1, 根据这个标志位, 途中的路由器即使遇到需要分片才能处理的包, 也不会去分片而是丢掉, 随后通不过一个 ICMP 的不可达消息将数据链路上的 MTU 值返回给发送主机, 发送主机将 MTU 设置为返回的 MTU, 如此反复直到发送主机不再收到 任何 ICMP  
以上为 UDP 的例子, 在 TCP 的情况下, 根据路径 MTU 的大小计算出最大段长度 (MSS), 然后再根据这些信息进行数据报的发送, 因此在 TCP 中如果采用路径 MTU 发现, IP 则不会再进行分片处理

#### IPv6
IPv6 是为了根本解决 IPv4 地址耗尽的问题而被标准化的网际协议; IPv6 地址长度为 128 比特, 写成 8 个 16 位字节

##### IPv6 的特点
- IP 地址的扩大与路由控制表的聚合
IP 地址依然适应互联网分层构造, 分配与其地址构造相适应的 IP 地址, 尽可能避免路由表膨大
- 性能提升
包首部长度采用固定的值 (40 字节), 不再采用首部检验码, 简化首部结构, 减轻路由负荷, 路由器不再做分片处理, 通过 MTU 发现只由发送端主机进行分片处理
- 支持即插即用功能
即使没有 DHCP 服务器也可以实现自动分配 IP 地址
- 采用认证与加密功能
应对伪造 IP 地址的网络安全功能以及防止线路窃听的功能 (IPsec)
- 多播, Mobile IP 成为扩展功能
多播和 Mobile IP 被定义为 IPv6 的扩展功能, 由此可以预期, 曾在 IPv4 中难于应用的这两个功能在 IPv6 中能够顺利使用

##### IPv6 中 IP 地址的标记方法
将 128 比特 IP 地址以每 16 比特为一组, 每组用冒号 (:) 隔开进行标记, 如果出现连续的 0 还可以将这些 0 省略, 并用两个冒号隔开, 但是一个 IP 地址中只允许出现一次两个连续的冒号

##### IPv6 地址的结构
| 种类 | IPv6 地址 | 简写 |
| :--- | :--- | :--- |
| 未定义 | 0000...000 (128 比特) | ::/128 |
| 环回地址 | 0000...001 (128 比特) | ::1/128 |
| 唯一本地地址 | 1111 110 | FC00::/7 |
| 链路本地单播地址 | 1111 1110 10 | FE80::/10 |
| 多播地址 | 1111 1111 | FF::/8|
| 全局单播地址 | - | - |

##### 全局单播地址
是指世界上唯一的一个地址, 是互联网通信以及各个域内部通信中最常用的一个 IPv6 地址  
现在 IPv6 的网络中使用的格式为, n = 48, m = 16, 以及 128 - n - m = 64, 即前 64 比特为网络标识, 后 64 比特为主机标识; 接口 ID 中保存 64 比特的 MAC 地址 (可能为一个临时地址)
```
|  全局路由前缀 (n)  |  子网 ID (m)   |   接口 ID (128 - n -m)  |
| <--- 广域网络 ---> | <- 站点内部 -> | <----- 接口标识码 -----> |
| <------------ 网络标识 ----------> | <----- 主机标识 -------> |
```

##### 链路本地单播地址
链路本地单播地址是指在同一个数据链路内唯一的地址, 它用于不经过路由器, 在同一个链路中的通信, 通常接口 ID 保存 64 比特的 MAC 地址
```
  10 比特              54 比特                            64 比特
|1111111010|             0              |                接口 ID                   |
```

##### 唯一本地地址
唯一本地地址是不进行互联网通信时所使用的地址; 为了提高安全性,企业内部网络与互联网通信时通常会通过 NAT 或网关 (代理) 进行, 而唯一本地地址正是在这种不联网或通过 NAT 以及代理联网的环境下使用的

##### IPv6 代理
IPv6 的分片处理只在作为起点的发送端主机上进行, 路由器不参与分片; IPv6 中最小的 MTU 为 1280 字节

#### IPv4 首部
TODO

#### IPv6 首部
TODO

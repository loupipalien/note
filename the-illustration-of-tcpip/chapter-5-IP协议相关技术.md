### IP 协议相关技术

#### 仅凭 IP 无法完成通信
在实际通信中, 仅凭 IP 远远不够, 还需要众多支持 IP 的相关技术才能够实现最终通信

#### DNS
DNS 能够将域名自动转换为具体的 IP 地址, 不仅适用于 IPv4, 也适用于 IPv6

##### IP 地址不便于记忆
起初将主机名转换为 IP 地址的方案是维护全网的 hosts 文件, 但随着网络越来越庞大这种方案难以为继

##### DNS 的产生
DNS 系统可以维护一个用来表示组织内部主机名和 IP 地址之间对应关系的数据库

##### 域名的产生
![域名的分层结构.png](http://ww1.sinaimg.cn/large/d8f31fa4ly1gbftfygpeoj20fj086dg4.jpg)  
- 域名服务器
域名服务器是指管理域名的主机和相应的软件, 它可以管理所在分层的域的相关信息
- 解析器
进行 DNS 查询的主机和软件叫做 DNS 解析器, 用户所在的工作站或个人电脑都属于解析器, 一个解析器至少要注册一个以上域名服务器的 IP 地址, 通常至少包含组织内部的域名服务器的 IP 地址

##### DNS 查询
解析器为了查找 IP 地址, 向域名服务器进行查询处理, 接收这个查询请求的域名服务器首先会在自己的数据库进行查找, 如果有该域名所对应的 IP 地址就返回, 如果没有则域名服务器再向上一层域名服务器进行查询  
解析器和域名服务器将最新了解到的信息暂时保存在缓存里, 这样可以减少每次查询时的性能消耗

##### DNS 如同互联网中的分布式数据库
DNS 是一种通过主机名检索 IP 地址的系统, 然而它所管理的信息不仅仅是这些主机名和 IP 地址之间的映射关系, 它还会管理其他众多信息: 例如主机名与 IP 地址的对应信息叫做 A 记录, 从 IP 地址检索主机名的信息叫做 PTR

| 类型 | 编号 | 内容 |
| :--- | :--- | :--- |
| A | 1 | 主机名的 IP 地址 (IPv4) |
| NS | 2 | 域名服务器 |
| CNAME | 5 | 主机别名对应的规范名称 |
| SOA | 6 | 区域内权威记录起始标志 |
| WKS | 11 | 已知服务 |
| PTR | 12 | IP 地址反向解析 |
| HINFO | 13 | 主机相关的追加信息 |
| MINFO | 14 | 邮箱与邮件组信息 |
| MX | 15 | 邮件交换 |
| TXT | 16 | 文本 |
| SIG | 24 | 安全证书 |
| KEY | 25 | 密钥 |
| GPOS | 27 | 地理位置 |
| AAAA | 28 | 主机的 IPv6 地址 |
| NXT | 30 | 下一代域名 |
| SRV | 33 | 服务器选择 |
| * | 255 | 所有缓存记录 |

#### ARP
##### ARP 概要
ARP 是一种解决地址问题的协议, 以目标 IP 地址为线索, 用来定位下一个应该接收数据分包的我那个了设备对应的 MAC 地址, 如果目标主机不再同一个链路上时, 可以通过 ARP 查找下一跳路由器的 MAC 地址; 不过 ARP 只适用于 IPv4, IPv6 中可使用 ICMPv6 来代替

##### ARP 的工作机制
ARP 借助 ARP 请求与 ARP 响应两种类型的包确定 MAC 地址

##### IP 地址和 MAC 地址缺一不可?
IP 地址传递不同数据链路之间的包, MAC 地址传递同一数据链路之内的包

##### RARP
RARP (Revers Address Resolution Protocol) 是从 MAC 地址定位 IP 地址的协议

##### 代理 ARP
通常 ARP 包会被路由器隔离, 但是采用代理 ARP 的路由器可以将 ARP 请求转发给邻近的网段

#### ICMP
##### 辅助 IP 的 ICMP
ICMP 的主要功能包括, 确认 IP 包是否成功送到目标地址, 通知在发送过程当中 IP 包被废弃的具体原因, 改善网络设置等; 有了这些功能后, 就可以获得网络是否正常, 设置是否有误以及设备有何异常信息等消息, 从而便于进行网络上的问题诊断  
ICMP 的消息大致可以分为两类: 一类是通知出错原因的错误消息, 另一类是用于诊断的查询消息

##### 主要的 ICMP 消息
- ICMP 目标不可达消息 (类型 3)
IP 路由器无法将 IP 数据包发送给目标地址时, 会给发送端主机返回一个目标不可达的 ICMP 消息, 并在这个消息中显示不可达的具体原因
- ICMP 重定向消息 (类型 5)
如果路由器发现发送端主机使用了次优的路径发送数据, 那么它会返回一个 ICMP 重定向的消息给主机, 这个消息包含了最合适的路由信息和源数据
- ICMP 超时消息 (类型 11)
IP 包中有一个字段叫做 TTL (Time To Live, 生存周期), 它的值随着每经过一次路由器就会减一, 直到减为 0 时该 IP 包就会被丢弃; 此时 IP 路由器会发送一个 ICMP 超时的消息给发送端主机; 设置 IP 包生存周期的主要目的是为了在路由控制遇到问题发生循环状况时, 避免 IP 包无休止的在网络上转发
- ICMP 回送消息 (类型 0, 8)
用于进行通信的主机或路由器之间, 判断所发送的数据包是否已经成功到达对端的一种消息; 最常用的 ping 命令就是利用这个消息实现的

##### 其他 ICMP 消息
- ICMP 原点抑制消息 (类型 4)
- ICMP 路由器探索消息 (类型 9, 10)
- ICMP 地址掩码消息 (类型 17, 18)

##### ICMPv6
- ICMPv6 的作用
在 IPv4 中 ICMP 仅作为一个辅助作用支持 IPv4, 然而在 IPv6 中 ICMP 的作用别扩大, 如将 IP 地址定位 MAC 地址的 ARP 转为 ICMP 的邻居探索消息, 这融合了 IPv4 的 ARP, ICMP 重定向以及 ICMP 路由器选择消息等功能于一体, 没有 ICMPv6 那么 IPv6 就无法正常通信
- 邻居探索
邻居请求消息用于查询 IPv6 的地址与 MAC 地址的对应关系

#### DHCP
##### DHCP 实现即插即用
DHCP (Dynamic Host Configuration Protocol) 是实现自动设置 IP 地址, 统一管理 IP 地址分配的服务; 有了 DHCP, 计算机只要连接到网络就可以进行 TCP/IP 通信

##### DHCP 的工作机制
使用 DHCP 之前, 首先要架设一台 DHCP 服务器, 然后将 DHCP 所要分配的 IP 地址设置到服务器上, 此外还需要将相应的子网掩码, 路由控制信息以及 DNS 服务器的地址等设置到服务器上  
为了检查所要分配的 IP 地址以及已经分配了的 IP 地址是否可用, DHCP 服务器或 DHCP 客户端必须具备以下功能
- DHCP 服务器: 在分配 IP 地址前发送 ICMP 回送请求包, 确认没有返回应答
- DHCP 客户端: 针对从 DHCP 获得的 IP 地址发送 ARP 请求包, 确认没有返回应答

##### DHCP 中继代理
TODO

#### NAT
##### NAT 定义
NAT (Network Address Translator) 是用于本地网络中使用私有地址, 在连接互联网时转而使用全局 IP 地址的技术, 由此可以实现一个全局 IP 地址与多个主机通信

##### NAT 的工作机制
以主机 `10.0.0.10` 的主机与 `163.221.120.9` 的主机进行通信为例, 利用 NAT, 途中 NAT 路由器将发送源地址从 `10.0.0.10` 转换为全局的 IP 地址 (202.244.172.37) 再发送数据, 反之当包从地址 `163.221.120.9` 发送回来时, 目标地址 (202.244.172.37) 先被转换为私有 IP 地址 `10.0.0.10` 以后再被转发  
当私有网络内多台机器同时都要与外部进行通信时, 仅仅转换 IP 地址容易导致全局 IP 地址不够用的问题, 这时采用包含端口号一起的转换方式 (NAPT) 可以解决这个问题  
在使用 TCP/UDP 的通信中, 只有目标地址, 源地址, 目标端口, 源端口以及协议类型五项内容都一致时才会被认为是同一个通信连接; 此时使用的正是 NAPT (Network Address Ports Translator)

##### NAT-PT (NAPT-PT)
NAT-PT 是将 IPv6 的首部转换为 IPv4 首部的一种技术, 使用这种技术那些只有 IPv6 地址的主机也就能够与 IPv4 地址的主机通信了

##### NAT 的潜在问题
由于 NAT (NAPT) 都依赖于自己的转换表, 因此会有以下几点限制
- 无法从 NAT 的外部向内部服务器建立连接
- 转换表的生产与转换操作都会产生一定的开销
- 通信过程中 NAT 遇到异常则需要重新启动, 所有的 TCP 连接都将被重置
- 即使备置两台 NAT 做容灾备份, TCP 连接还是会被断开

##### 解决 NAT 的潜在问题与 NAT 穿越
- 改用 IPv6, 不再使用 NAT
- NAT 穿越

#### IP 隧道
![IP隧道.png](http://ww1.sinaimg.cn/large/d8f31fa4ly1gbg2uzj91fj209t02wa9z.jpg)   
网络 A, B 使用 IPv6, 如果处于中间位置的网络 C 支持使用 IPv4 的话, 网络 A 和 B 之间将无法直接进行通信, 为了它们之间正常通信必须采用 IP 隧道的功能; IP 隧道中可以将那些从网络 A 发过来的 IPv6 的包统和为一个数据, 再为之追加一个 IPv4 的首部以后转发给网络 C  
一般情况下, 紧接着 IP 首部的是 TCP 或 UDP 的首部, 然而现在应用当中 "IP 首部后还是 IP 首部" 或者 "IP 首部后是 IPv6 首部"; 这种在网络层的首部后面继续追加网络层首部的通信方式就叫做 IP 隧道

#### 其他 IP 相关技术
##### IP 多播相关技术
TODO
##### IP 任播
TODO
##### 通信质量控制
TODO
##### 显式拥塞通知
TODO
##### Mobile IP
TODO
